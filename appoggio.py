exams = [

        {'my_acid': 0},
        {'p_acid': 0},
        {'st_acid': 0},
        {'ar_acid': 0},
        {'beenic_acid': 0},
        {'pal_acid': 0},
        {'ol_acid': 0},
        {'ner_acid': 0},
        {'a_linoleic_acid': 0},
        {'eico_acid': 0},
        {'doco_acid': 0},
        {'lin_acid': 0},
        {'gamma_lin_acid': 0},
        {'dih_gamma_lin_acid': 0},
        {'arachidonic_acid': 0},
        {'sa_un_fatty_acid': 0},
        {'o3o6_fatty_acid_quotient': 0},
        {'aa_epa': 0},
        {'o3_index': 0},
        {'neut_ul': 2.95},
        {'lymph_ul': 2},
        {'mono_ul': 0.28},
        {'eosi_ul': 0.17},
        {'baso_ul': 0.03},
        {'rdwcv': 12.2},
        {'hct_w': 37.7},
        {'hgb_w': 13.6},
        {'rbc_w': 4.45},
        {'azotemia': 55},
        {'uric_acid': 2.9},
        {'creatinine_w': 0.7},
        {'uricemy_w': 2.9},
        {'cistatine_c': 0},
        {'plt': 209},
        {'mpv': 10.8},
        {'plcr': 32.0},
        {'pct': 0.230},
        {'pdw': 12},
        {'d_dimero': 0},
        {'pai_1': 0},
        {'tot_chol': 222},  
        {'ldl_chol': 104},
        {'hdl_chol_w': 103},
        {'trigl': 50},
        {'na': 141},
        {'k': 4.3},
        {'mg': 1.8},
        {'ci': 0},
        {'ca': 9.9},
        {'p': 4.3},
        {'dhea_w': 0},  
        {'testo_w': 0},
        {'tsh': 3.97},
        {'ft3': 0},
        {'ft4': 0},
        {'beta_es_w': 0},
        {'prog_w': 0},
        {'fe': 0},
        {'transferrin': 212},
        {'ferritin_w': 280.3},
        {'glicemy': 93},
        {'insulin': 4.2},
        {'homa': 0},
        {'ir': 0},
        {'albuminemia': 0}, 
        {'tot_prot': 7.30},
        {'tot_prot_ele': 7.30},
        {'albumin_ele': 63.6},
        {'a_1': 7.80},             
        {'a_2': 8.02},
        {'b_1': 5.34},
        {'b_2': 3.34},
        {'gamma': 12.15},
        {'albumin_dI': 4.6},              
        {'a_1_dI': 0.57},
        {'a_2_dI': 0.59},
        {'b_1_dI': 0.39},
        {'b_2_dI': 0.24},
        {'gamma_dI': 0.89},                      
        {'ag_rap': 1.73},
        {'cm': 0},
        {'b_2_spike': b_2_spike},
        {'got_w': got_w},
        {'gpt_w': gpt_w},                    
        {'g_gt_w': g_gt_w},
        {'a_photo_w': a_photo_w},
        {'tot_bili': tot_bili},                   
        {'direct_bili': direct_bili},
        {'indirect_bili': indirect_bili},
        {'ves': ves},
        {'pcr_c': pcr_c},                  
        {'tnf_a': tnf_a},
        {'inter_6': inter_6},
        {'inter_10': inter_10},
        {'scatolo': scatolo},                     
        {'indicano': indicano},
        {'s_weight': s_weight},
        {'ph': ph},
        {'proteins_ex': proteins_ex},                      
        {'blood_ex': blood_ex},
        {'ketones': ketones},
        {'uro': uro},
        {'bilirubin_ex': bilirubin_ex}, 
        {'leuc': leuc},
        {'glucose': glucose},
        {'shbg_w': shbg_w},
        {'nt_pro': nt_pro},  
        {'v_b12': v_b12},
        {'v_d': v_d},
        {'ves2': ves2},
        {'telotest': telotest},                        
]



exams = [
        {'uric_acid': 0 },
        {'aa_epa': 0},
        {'neut_ul': 2.95},
        {'lymph_ul': 2},
        {'mono_ul': 0.28},
        {'eosi_ul': 0.17},
        {'baso_ul': 0.03},
        {'rdwcv': 12.2},
        {'hct_w': 37.7},
        {'hgb_w': 13.6},
        {'rbc_w': 4.45},
        {'azotemia': 55},
        {'uric_acid': 2.9},
        {'creatinine_w': 0.7},
        {'uricemy_w': 2.9},
        {'plt': 209},
        {'mpv': 10.8},
        {'plcr': 32.0},
        {'pct': 0.230},
        {'pdw': 12},
        {'d_dimero': 0},
        {'na': 141},
        {'k': 4.3},
        {'mg': 1.8},
        {'ca': 9.9},
        {'p': 4.3},
        {'tsh': 3.97},
        {'transferrin': 212},
        {'ferritin_w': 280.3},
        {'glicemy': 93},
        {'insulin': 4.2},
        {'tot_prot': 7.30},
        {'tot_prot_ele': 7.30},
        {'albumin_ele': 63.6},
        {'a_1': 7.80},             
        {'a_2': 8.02},
        {'b_1': 5.34},
        {'b_2': 3.34},
        {'gamma': 12.15},
        {'albumin_dI': 4.6},              
        {'a_1_dI': 0.57},
        {'a_2_dI': 0.59},
        {'b_1_dI': 0.39},
        {'b_2_dI': 0.24},
        {'gamma_dI': 0.89},                      
        {'ag_rap': 1.73},
        {'cm': 0},
        {'b_2_spike': 0},
        {'got_w': 18},
        {'gpt_w': 16},                    
        {'g_gt_w': 6},
        {'a_photo_w': 61},
        {'tot_bili': 0.43},                   
        {'direct_bili': 0.19},
        {'indirect_bili': 0.24},
        {'ves': 0},
        {'pcr_c': 0.5},                  
        {'inter_6': 0},
        {'inter_10': 0},
        {'ph': 5},
        {'proteins_ex': 0},                      
        {'blood_ex': 0},
        {'ketones': 0},
        {'uro': 0.2},
        {'bilirubin_ex': 0.0}, 
        {'leuc': 3},
        {'glucose': 0},
        {'nt_pro': 0},  
        {'telotest': 0},                        
]



exams = [
        {'my_acid': 0},
        {'p_acid': 0},
        {'st_acid': 0},
        {'ar_acid': 0},
        {'beenic_acid': 0},
        {'pal_acid': 0},
        {'ol_acid': 0},
        {'ner_acid': 0},
        {'a_linoleic_acid': 0},
        {'eico_acid': 0},
        {'doco_acid': 0},
        {'lin_acid': 0},
        {'gamma_lin_acid': 0},
        {'dih_gamma_lin_acid': 0},
        {'arachidonic_acid': 0},
        {'sa_un_fatty_acid': 0},
        {'o3o6_fatty_acid_quotient': 0},
        {'aa_epa': 0},
        {'o3_index': 0},
        {'neut_ul': 2.95},
        {'lymph_ul': 2},
        {'mono_ul': 0.28},
        {'eosi_ul': 0.17},
        {'baso_ul': 0.03},
        {'rdwcv': 12.2},
        {'hct_w': 37.7},
        {'hgb_w': 13.6},
        {'rbc_w': 4.45},
        {'azotemia': 55},
        {'uric_acid': 2.9},
        {'creatinine_w': 0.7},
        {'uricemy_w': 2.9},
        {'cistatine_c': 0},
        {'plt': 209},
        {'mpv': 10.8},
        {'plcr': 32.0},
        {'pct': 0.230},
        {'pdw': 12},
        {'d_dimero': 0},
        {'pai_1': 0},
        {'tot_chol': 222},  
        {'ldl_chol': 104},
        {'hdl_chol_w': 103},
        {'trigl': 50},
        {'na': 141},
        {'k': 4.3},
        {'mg': 1.8},
        {'ci': 0},
        {'ca': 9.9},
        {'p': 4.3},
        {'dhea_w': 0},  
        {'testo_w': 0},
        {'tsh': 3.97},
        {'ft3': 0},
        {'ft4': 0},
        {'beta_es_w': 0},
        {'prog_w': 0},
        {'fe': 0},
        {'transferrin': 212},
        {'ferritin_w': 280.3},
        {'glicemy': 93},
        {'insulin': 4.2},
        {'homa': 0},
        {'ir': 0},
        {'albuminemia': 0}, 
        {'tot_prot': 7.30},
        {'tot_prot_ele': 7.30},
        {'albumin_ele': 63.6},
        {'a_1': 7.80},             
        {'a_2': 8.02},
        {'b_1': 5.34},
        {'b_2': 3.34},
        {'gamma': 12.15},
        {'albumin_dI': 4.6},              
        {'a_1_dI': 0.57},
        {'a_2_dI': 0.59},
        {'b_1_dI': 0.39},
        {'b_2_dI': 0.24},
        {'gamma_dI': 0.89},                      
        {'ag_rap': 1.73},
        {'got_w': 18},
        {'gpt_w': 16},                    
        {'g_gt_w': 6},
        {'a_photo_w': 61},
        {'tot_bili': 0.43},                   
        {'direct_bili': 0.19},
        {'indirect_bili': 0.24},
        {'ves': 0},
        {'pcr_c': 0},                  
        {'tnf_a': 0},
        {'inter_6': 0},
        {'inter_10': 0},
        {'scatolo': 0},                     
        {'indicano': 0},
        {'s_weight': 0},
        {'ph': 5},
        {'proteins_ex': 0},                      
        {'blood_ex': 0},
        {'ketones': 0},
        {'uro': 0.2},
        {'bilirubin_ex': 0.0}, 
        {'leuc': 0},
        {'glucose': 0},
        {'shbg_w': 0},
        {'nt_pro': 0},  
        {'v_b12': 0},
        {'v_d': 0},
        {'ves2': 0},
        {'telotest': 0},                        
]
















class PrescrizioniView(View):

    def get(self, request, persona_id):
        json_path = os.path.join(settings.STATIC_ROOT, "includes", "json", "ArchivioEsami.json")

        if not os.path.exists(json_path):
            return JsonResponse({"error": f"File JSON non trovato: {json_path}"}, status=404)

        with open(json_path, "r", encoding="utf-8") as file:
            data = json.load(file)

        persona = get_object_or_404(TabellaPazienti, id=persona_id)
        codiciEsami = PrescrizioniUtenti.objects.filter(paziente=persona)

        esamiList = []

        for codici in codiciEsami:
            for esame in data['Foglio1']:
                if int(codici.codicePrescrizione) == int(esame['CODICE_UNIVOCO_ESAME_PIATTAFORMA']):
                    esamiList.append(esame)

        dottore_id = request.session.get('dottore_id')
        dottore = get_object_or_404(UtentiRegistratiCredenziali, id=dottore_id)

        success_message = request.session.pop('success', None)
        error_message = request.session.pop('errore', None)

        context = {
            'persona': persona,
            'dottore': dottore,
            'esamiPrescritti': esamiList,
            'success': success_message, 
            'errore': error_message, 
        }

        return render(request, "includes/prescrizioni.html", context)


    def post(self, request, persona_id):
        json_path = os.path.join(settings.STATIC_ROOT, "includes", "json", "ArchivioEsami.json")

        if not os.path.exists(json_path):
            return JsonResponse({"error": f"File JSON non trovato: {json_path}"}, status=404)

        with open(json_path, "r", encoding="utf-8") as file:
            data = json.load(file)

        codiciEsami = request.POST.getlist('codiceEsame')
        persona = get_object_or_404(TabellaPazienti, id=persona_id)

        esami_duplicati = []
        esami_nuovi = []

        for codice in codiciEsami:
            if PrescrizioniUtenti.objects.filter(paziente=persona, codicePrescrizione=codice).exists():
                esami_duplicati.append(codice)
            else:
                prescrizione = PrescrizioniUtenti(paziente=persona, codicePrescrizione=codice)
                prescrizione.save()
                esami_nuovi.append(codice)

        if esami_duplicati:
            with open(json_path, "r", encoding="utf-8") as file:
                data = json.load(file)
            
            dataList = data['Foglio1']
            nome_esame = ''

            for dictionary in dataList:
                if int(dictionary['CODICE_UNIVOCO_ESAME_PIATTAFORMA']) == int(esami_duplicati[0]):
                    nome_esame = dictionary['DESCRIZIONE_ESAME']

            request.session['errore'] = f"L'esame '{nome_esame}' è già presente nell'elenco delle prescrizioni per questo paziente"
        else:
            
            request.session['success'] = "Le prescrizioni sono state correttamente aggiunte"

        return redirect('prescrizioni', persona_id)
 













class DeletePrescrizioniView(View):
    
    def post(self, request, persona_id):
        try:
            persona = get_object_or_404(TabellaPazienti, id=persona_id)
            codice_univoco = request.POST.get("codiceUnivoco")

            if not codice_univoco:
                return JsonResponse({"error": "Codice esame non fornito"}, status=400)

            esame = PrescrizioniUtenti.objects.filter(paziente=persona, codicePrescrizione=codice_univoco)

            if not esame.exists():
                return JsonResponse({"error": "Esame non trovato"}, status=404)

            nome_esame = ""
            primo_elemento = esame.first()

            json_path = os.path.join(settings.STATIC_ROOT, "includes", "json", "ArchivioEsami.json")
            if os.path.exists(json_path):
                with open(json_path, "r", encoding="utf-8") as file:
                    data = json.load(file)
                    for dictionary in data.get("Foglio1", []):
                        if int(dictionary["CODICE_UNIVOCO_ESAME_PIATTAFORMA"]) == int(primo_elemento.codicePrescrizione):
                            nome_esame = dictionary["DESCRIZIONE_ESAME"]

            esame.delete()

            request.session['success'] = f"L'esame '{nome_esame}' è stato eliminato"

            return JsonResponse({"reload": True}) 

        except Exception as e:
            return JsonResponse({"error": str(e)}, status=500)






<form method="POST" action="{% url 'prescrizioni' persona.id %}">
                {% csrf_token %}
                
                <div class="conteiner-CodaPrescrizioni">
                    <!-- DINAMICAMENTE POPOLATO CON JAVASCRIPT -->
                </div>

                <button type="submit" title="Add Patient" class="button" id="buttonAdd">
                    <span class="button__icon-wrapper">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="button__icon-svg" width="14"
                        height="14">
                        <path d="M12 4V20M4 12H20" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" />
                    </svg>
                
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"
                        class="button__icon-svg button__icon-svg--copy" width="14" height="14">
                        <path d="M12 4V20M4 12H20" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" />
                    </svg>
                
                    </span>
                    Aggiungi Prescrizioni
                </button>
            </form>





<div class="table-content">
                <!-- Da Popolare Dinamicamente -->
                {% if esamiPrescritti %}

                    {% for esami in esamiPrescritti %}
                    <div class="rowTable" id="esame-{{ esami.CODICE_UNIVOCO_ESAME_PIATTAFORMA }}">
                        <p>{{ esami.CODICE_UNIVOCO_ESAME_PIATTAFORMA }}</p>
                        <p>{{ esami.DESCRIZIONE_ESAME }}</p>
                        <p>{{ esami.COD_ASL }}</p>
                        <p>{{ esami.COD_REG }}</p>
                        <p>{{ esami.METODICA }}</p>
                        <p style="padding:10px;">{{ esami.APPARATO_or_I_SISTEMI|slice:":50" }}</p>
                        
                        <p id="cellaButton">
                            <button class="delete-button" data-codice="{{ esami.CODICE_UNIVOCO_ESAME_PIATTAFORMA }}">❌</button>
                        </p>
                       
                    </div>
                    {% endfor %}
        
                {% else %}
                    <div class="Message">
                        <p>Clicca su 'Aggiungi Prescrizione' per aggiungere le prescrizioni alla visita corrente</p>
                    </div>
                {% endif %}

                <!-- FUNZIONE AJAX PER RICHIESTA DI DELETE -->
                <!-- <script>
                   document.querySelectorAll('.delete-button').forEach(button => {
                        button.addEventListener('click', function() {
                            let codiceUnivoco = this.getAttribute('data-codice');
                            let esameRow = document.getElementById(`esame-${codiceUnivoco}`);

                            let csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value; 

                            fetch("{% url 'delete_exam' persona.id %}", {
                                method: "POST",
                                headers: {
                                    "X-CSRFToken": csrfToken,
                                    "Content-Type": "application/x-www-form-urlencoded"
                                },
                                body: `codiceUnivoco=${codiceUnivoco}`
                            })
                            .then(response => response.json()) 
                            .then(data => {
                                if (data.reload) {
                                    window.location.reload(); 
                                } else {
                                   
                                    let errorMessage = document.getElementById("error-message");
                                    if (errorMessage) {
                                        errorMessage.innerText = data.error;
                                        errorMessage.style.display = "block";
                                    }
                                }
                            })
                            .catch(error => console.error("Errore nella richiesta:", error));
                        });
                    });



                </script>
                    

                 -->
            </div>



 document.querySelectorAll(".add-btn").forEach((button) => {
    button.addEventListener("click", (event) => {
        const esameId = event.target.getAttribute("data-id");
        const esameNome = event.target.getAttribute("data-nome");
        const esameCodice = event.target.getAttribute("data-codice");
        const esameAsl = event.target.getAttribute("data-asl");
        const esameReg = event.target.getAttribute("data-reg");
        const esameMetodica = event.target.getAttribute("data-metodica");
        const esameApparato = event.target.getAttribute("data-apparato");

        const queueContainer = document.querySelector(".conteiner-CodaPrescrizioni");

        // Verifica se esiste già un elemento con lo stesso codice univoco
        const alreadyExists = Array.from(queueContainer.children).some(row => 
            row.querySelector('[name="codiceEsame"]')?.textContent === esameCodice
        );

        if (alreadyExists) {
            alert("L'esame è già stato aggiunto!");
            return;
        }

        const codaItem = document.createElement("div");
        codaItem.classList.add("rowModale", "coda-item");
        codaItem.setAttribute("data-id", esameId);
        codaItem.innerHTML = `
            <div class="colModale" name="codiceEsame">${esameCodice}</div>
            <input type="hidden" id="codiceEsameInput" name="codiceEsame" value="${esameCodice}">
            <div class="colModale nomeEsame">${esameNome}</div>
            <div class="colModale">${esameAsl ? `${esameAsl} (cod. asl)` : ""}</div>
            <div class="colModale">${esameReg ? `${esameReg} (cod. reg)` : ""}</div>
            <div class="colModale metodica">${esameMetodica}</div>
            <div class="colModale apparati">${esameMetodica}</div>
            <div class="colModale">
                <button class="remove-btn">❌</button>
            </div>
        `;

        queueContainer.appendChild(codaItem);

        codaItem.querySelector(".remove-btn").addEventListener("click", () => {
            codaItem.remove();
        });
    });
  });