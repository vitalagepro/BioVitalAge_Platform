{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <!-- Favicon -->
    <link rel="sortcut icon" href='{% static "includes/icone/favicon.png" %}' type="image/x-icon">

    <title>Piano Terapeutico</title>

    <!-- Css Import -->
    <link rel="stylesheet" href="{% static 'includes/css/Componenti.css' %}">
    <link rel="stylesheet" href="{% static 'includes/css/piano_terapeutico/piano_terapeutico.css' %}">
    <link rel="stylesheet" href="{% static 'includes/css/homePage.css' %}">

    <!-- Bootstrap import -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Import  -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300..700&display=swap" rel="stylesheet">

    <!-- JS IMPORT -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://unpkg.com/libphonenumber-js/bundle/libphonenumber-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.16.0/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
</head>

<body>
    <!-- Loader -->
    {% include 'components/loader.html' %}

    <!-- NAVBAR -->
    {% include 'components/navBar.html' %}

    <main>
        <!-- MENU TRACE -->
        <div class="main-title-nav">

            <div class="back-tittle">

                <a id="back" href="{% url 'cartella_paziente' persona.id %}"><img src="{% static 'includes/icone/arrowBack.png' %}"></a>
                <h2 class="main-welcome-title">
                    <span>{{ persona.surname|title }}</span>
                    <span>{{ persona.name|title }}</span> |
                    <span>Età: {{ persona.chronological_age }}</span>
                    {% if persona.phone and persona.email %}
                    |
                    <span class="phone_span">
                        <img src="{% static 'includes/icone/phone.png' %}" width="20px" height="20px">
                        Telefono: {{ persona.phone }}
                    </span> |
                    <span class="email_span">
                        <img src="{% static 'includes/icone/emailNew.png' %}" width="20px" height="20px">
                        Email: {{ persona.email }}
                    </span>
                    {% endif %}
                </h2>

            </div>
        
            <div class="main-menu-trace">
                <a href="{% url 'HomePage' %}">
                    <img src="{% static 'includes/icone/homePage.png' %}" alt="Home Page" title="Home Page" />
                </a>
                <p>»</p>
                <p>
                    <a href="{% url 'Risultati' %}">Pazienti</a>
                </p>
                <p>»</p>
                <p>Cartella Paziente</p>
            </div>
        
        </div>

      
        <!-- PRESCRIZIONI ESAMI -->
        <!-- MODALE -->        
        {% if elencoPrescrizioni %}
            <div class="backdropModalePrescrizioni" id="backdropPrescrizioni"></div>
            
            <div class="ModalPrescrizione" id="modalePrescrizioni">
                <div class="title-container">
                    <H3>Dettagli visita del {{ visita.data_visita }}</H3>
                    <button onclick="closeModal()" class="close">X</button>
                </div>

                <div class="prescrizioniTable-header">
                    <p>ID Esame</p>
                    <p>Descrizione Esame</p>
                    <p>Metodica</p>
                    <p>Codice Asl</p>
                    <p>Codice Reg</p>
                    <p id="last">Apparato / Sistema</p>
                </div>
                
                <div class="ModalPrescrizioni-content">
                   
                    <div class="table-content">
                        {% for codice_esame, dettagli in elencoPrescrizioni.items %}
                            <div class="prescrizoniRow">
                                <p>{{ codice_esame }}</p>
                                <p>{{ dettagli.DESCRIZIONE_ESAME }}</p>
                                <p>{{ dettagli.METODICA }}</p>
                                <p>{{ dettagli.COD_ASL }}</p>
                                <p>{{ dettagli.COD_REG }}</p>
                                <p id="last">{{ dettagli.APPARATO_or_I_SISTEMI|slice:":20" }}</p>
                            </div>
                        {% endfor %}
                    </div>
                    
                </div>
            </div>    
        {% endif %}

        {% if lista_nomi_esami %}
            {% for esame in lista_nomi_esami %}
                <input type="hidden" id="lista_esami" class="esame_nascosto" value="{{ lista_nomi_esami|join:',' }}">
            {% endfor %}
        {% endif %}


        <!-- TABELLA PRESCRIZIONI ESAMI -->
        <div class="contenitore-tabella" style="margin-top: 0; ">

            <div class="recent-patients" id="card-style">

                <div class="contenitore-header">
                    <h3>Elenco Prescrizioni Esami</h3>

                    <div class="filtri-button">

                        <select name="filter" id="filter" style="width: 10rem;">

                            <option>Tutti</option>
                            <option value="0">Descrizione Esame Crescente</option>
                            <option value="1">Descrizione Esame Decrescente</option>
                            <option value="2">Metodica</option>
                            <option value="3">Codice Asl</option>
                            <option value="4">Codice Regione</option>
                            <option value="5">Apparati / Sitemi</option>

                        </select>

                        <button id="downloadPrescrizioneVuota" class="button" style="width: 4rem;"> 
                            <span class="button__icon-wrapper">
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    width="18"
                                    class="button__icon-svg"
                                >
                                    <path
                                        d="M12 3V16M12 16L8 12M12 16L16 12"
                                        stroke="currentColor"
                                        stroke-width="2"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                    />
                                    <path
                                        d="M4 20H20"
                                        stroke="currentColor"
                                        stroke-width="2"
                                        stroke-linecap="round"
                                    />
                                </svg>

                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    width="18"
                                    class="button__icon-svg button__icon-svg--copy"
                                >
                                    <path
                                        d="M12 3V16M12 16L8 12M12 16L16 12"
                                        stroke="currentColor"
                                        stroke-width="2"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                    />
                                    <path
                                        d="M4 20H20"
                                        stroke="currentColor"
                                        stroke-width="2"
                                        stroke-linecap="round"
                                    />
                                </svg>

                            </span>
                        </button>

                        <a href="{% url 'prescrizioni' persona.id %}" class="button" style="width: 15rem;"> 
                            <span class="button__icon-wrapper">
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    width="18"
                                    class="button__icon-svg"
                                >
                                    <path
                                        d="M12 5V19M5 12H19"
                                        stroke="currentColor"
                                        stroke-width="2"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                    />
                                </svg>

                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    width="18"
                                    class="button__icon-svg button__icon-svg--copy"
                                >
                                    <path
                                        d="M12 5V19M5 12H19"
                                        stroke="currentColor"
                                        stroke-width="2"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                    />
                                </svg>

                            </span>
                            Aggiungi Prescrizioni
                        </a>
                    </div>

                </div>

                <div class="table-container">
                    <div class="table-header">
                        <p>Id Visita</p>
                        <p>Data Visita</p>
                        <p>Visualizza Dettagli</p>
                        <p>Scarica Prescrizione</p>
                    </div>
                    <div class="table-content prescriptions">

                        {% for visite in visite %}
                            <div class="riga-container">
                                <p>{{ visite.id }}</p>
                                <p>{{ visite.data_visita|date:"d/m/Y" }}</p>
                                <p>
                                    <a href="{% url 'dettagli_prescrizioni' persona.id visite.id %}">
                                        <img src="{% static 'includes/icone/referto.png' %}" alt="" />
                                    </a>
                                </p>
                                <p>
                                    <a href="{% url 'scarica_pdf' persona.id visite.id %}" 
                                        id="pdfLink"> 
                                        <img src="{% static 'includes/icone/download.png' %}" alt="Download" />
                                    </a>
                                </p>
                                
                            </div>

                            {% empty %}
                            <p class="text-center mt-2 mb-2">No recent prescription found.</p>
                        {% endfor %}        
                    </div>          
                </div>            
            </div>
        </div>











        <!-- PRESCRIZIONI FARMACI -->
        <!-- MODALE  -->
        {% if elencoPrescrizioni %}
            <div class="backdropModalePrescrizioni" id="backdropPrescrizioni"></div>
            
            <div class="ModalPrescrizione" id="modalePrescrizioni">
                <div class="title-container">
                    <H3>Dettagli visita del {{ visita.data_visita }}</H3>
                    <button onclick="closeModal()" class="close">X</button>
                </div>

                <div class="prescrizioniTable-header">
                    <p>ID Esame</p>
                    <p>Descrizione Esame</p>
                    <p>Metodica</p>
                    <p>Codice Asl</p>
                    <p>Codice Reg</p>
                    <p id="last">Apparato / Sistema</p>
                </div>
                
                <div class="ModalPrescrizioni-content">
                   
                    <div class="table-content">
                        {% for codice_esame, dettagli in elencoPrescrizioni.items %}
                            <div class="prescrizoniRow">
                                <p>{{ codice_esame }}</p>
                                <p>{{ dettagli.DESCRIZIONE_ESAME }}</p>
                                <p>{{ dettagli.METODICA }}</p>
                                <p>{{ dettagli.COD_ASL }}</p>
                                <p>{{ dettagli.COD_REG }}</p>
                                <p id="last">{{ dettagli.APPARATO_or_I_SISTEMI|slice:":20" }}</p>
                            </div>
                        {% endfor %}
                    </div>
                    
                </div>
            </div>    
        {% endif %}

        {% if lista_nomi_esami %}
            {% for esame in lista_nomi_esami %}
                <input type="hidden" id="lista_esami" class="esame_nascosto" value="{{ lista_nomi_esami|join:',' }}">
            {% endfor %}
        {% endif %}

        <!-- TABELLA -->
        <div class="contenitore-tabella" style="margin-top: 0; ">

            <div class="recent-patients" id="card-style">

                <div class="contenitore-header">
                    <h3>Elenco Prescrizioni Farmaci</h3>

                    <div class="filtri-button">

                        <select name="filter" id="filter" style="width: 10rem;">

                            <option>Tutti</option>
                            <option value="0">Descrizione Esame Crescente</option>
                            <option value="1">Descrizione Esame Decrescente</option>
                            <option value="2">Metodica</option>
                            <option value="3">Codice Asl</option>
                            <option value="4">Codice Regione</option>
                            <option value="5">Apparati / Sitemi</option>

                        </select>

                        <button id="downloadPrescrizioneVuota" class="button" style="width: 4rem;"> 
                            <span class="button__icon-wrapper">
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    width="18"
                                    class="button__icon-svg"
                                >
                                    <path
                                        d="M12 3V16M12 16L8 12M12 16L16 12"
                                        stroke="currentColor"
                                        stroke-width="2"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                    />
                                    <path
                                        d="M4 20H20"
                                        stroke="currentColor"
                                        stroke-width="2"
                                        stroke-linecap="round"
                                    />
                                </svg>

                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    width="18"
                                    class="button__icon-svg button__icon-svg--copy"
                                >
                                    <path
                                        d="M12 3V16M12 16L8 12M12 16L16 12"
                                        stroke="currentColor"
                                        stroke-width="2"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                    />
                                    <path
                                        d="M4 20H20"
                                        stroke="currentColor"
                                        stroke-width="2"
                                        stroke-linecap="round"
                                    />
                                </svg>

                            </span>
                        </button>

                        <a href="{% url 'prescrizioni' persona.id %}" class="button" style="width: 15rem;"> 
                            <span class="button__icon-wrapper">
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    width="18"
                                    class="button__icon-svg"
                                >
                                    <path
                                        d="M12 5V19M5 12H19"
                                        stroke="currentColor"
                                        stroke-width="2"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                    />
                                </svg>

                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    width="18"
                                    class="button__icon-svg button__icon-svg--copy"
                                >
                                    <path
                                        d="M12 5V19M5 12H19"
                                        stroke="currentColor"
                                        stroke-width="2"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                    />
                                </svg>

                            </span>
                            Aggiungi Prescrizioni
                        </a>
                    </div>

                </div>

                
                <div class="table-container">
                    <div class="table-header">
                        <p>Id Visita</p>
                        <p>Data Visita</p>
                        <p>Visualizza Dettagli</p>
                        <p>Scarica Prescrizione</p>
                    </div>
                    <div class="table-content prescriptions">

                        {% for visite in visite %}
                            <div class="riga-container">
                                <p>{{ visite.id }}</p>
                                <p>{{ visite.data_visita|date:"d/m/Y" }}</p>
                                <p>
                                    <a href="{% url 'dettagli_prescrizioni' persona.id visite.id %}">
                                        <img src="{% static 'includes/icone/referto.png' %}" alt="" />
                                    </a>
                                </p>
                                <p>
                                    <a href="{% url 'scarica_pdf' persona.id visite.id %}" 
                                        id="pdfLink"> 
                                        <img src="{% static 'includes/icone/download.png' %}" alt="Download" />
                                    </a>
                                </p>
                                
                            </div>

                            {% empty %}
                            <p class="text-center mt-2 mb-2">No recent prescription found.</p>
                        {% endfor %}

                        
                    </div>          
                </div>            
            </div>
        </div>

    </main>


    <!-- IMPORT JS PRE BODY CLOSE TAG -->

    <!-- SCRIPT PRESCRIZIONE ESAMI -->
    <!-- DOCX VUOTO -->
    <!-- <script>        
        async function generatePDF() {

            try {
                const existingPdfBytes = await fetch('/static/includes/pdfTemplates/prescrizioneTemplate.pdf').then((res) => res.arrayBuffer());
                const pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes);
                const firstPage = pdfDoc.getPages()[0];

                const logoUrl = "/static/includes/pdfTemplates/logo.png";
                const logo2Url = "/static/includes/pdfTemplates/logo2.png";

                const logoImageBytes = await fetch(logoUrl).then(res => res.arrayBuffer());
                const logo2ImageBytes = await fetch(logo2Url).then(res => res.arrayBuffer());

                const logoImage = await pdfDoc.embedPng(logoImageBytes);
                const logo2Image = await pdfDoc.embedPng(logo2ImageBytes);


                firstPage.drawImage(logoImage, { x: 180, y: 20, width: 250, height: 140 });
                firstPage.drawImage(logo2Image, { x: 190, y: 730, width: 200, height: 100 });


                const pageWidth = firstPage.getWidth();
                const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
                const fontSize = 12;

                const alignRight = (text, y) => {
                    const textWidth = font.widthOfTextAtSize(text, fontSize);
                    const xPosition = pageWidth - textWidth - 50;
                    firstPage.drawText(text, { x: xPosition, y: y, size: fontSize, font: font });
                };

                const persona = {
                    name: "{{ persona.name }}",
                    surname: "{{ persona.surname }}",
                    pob: "{{ persona.pob }}",
                    dob: "{{ persona.dob }}"
                };

                alignRight(`Sig.ra/Sig. ${persona.name} ${persona.surname}`, 640);
                alignRight(`Città di nascita: ${persona.pob}`, 615);
                alignRight(`Data di nascita: ${persona.dob}`, 590);


                firstPage.drawText("Si prescrivono i seguenti esami:", { x: 50, y: 560, size: fontSize, font: font });
                firstPage.drawText("Diagnosi:", { x: 50, y: 300, size: fontSize, font: font });

                const today = new Date();
                const formattedDate = today.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' });

                firstPage.drawText(`Bari, ${formattedDate}`, { x: 50, y: 200, size: fontSize, font: font });

                const text = "Dott. Luigi Aprile:";
                const textWidth = font.widthOfTextAtSize(text, fontSize);
                const xPosition = pageWidth - textWidth - 50;
                firstPage.drawText(text, { x: xPosition, y: 150, size: fontSize, font: font });


                const modifiedPdfBytes = await pdfDoc.save();
                const blob = new Blob([modifiedPdfBytes], { type: "application/pdf" });


                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `${persona.name}_${persona.surname}.pdf`;
                link.click();

            }
            catch (error) {
                    console.error("Errore nella generazione del PDF:", error);
            }
        }

        const downloadButton = document.getElementById('downloadPrescrizioneVuota')
        downloadButton.addEventListener("click", generatePDF);


    </script> 
 -->
    
 
    <!-- MODALE -->
    <script>
        function closeModal(){
            document.getElementById('modalePrescrizioni').style.display = 'none';
            document.getElementById('backdropPrescrizioni').style.display = 'none';
        }
    </script>

    <!-- SCRIPT PRESCRIZIONE ESAMI -->
    <script>
            
        async function generatePDF(pdfUrl, logoUrl, logo2Url, name, surname, dob, pob, fileName) {
            if (!pdfUrl) {
                console.error("Errore: Nessun URL PDF specificato!");
                return;
            }
    
            try {
                const existingPdfBytes = await fetch(pdfUrl).then((res) => res.arrayBuffer());
                const pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes);
                const firstPage = pdfDoc.getPages()[0];
    
                const logoImageBytes = await fetch(logoUrl).then(res => res.arrayBuffer());
                const logo2ImageBytes = await fetch(logo2Url).then(res => res.arrayBuffer());
    
                const logoImage = await pdfDoc.embedPng(logoImageBytes);
                const logo2Image = await pdfDoc.embedPng(logo2ImageBytes);
    
                firstPage.drawImage(logoImage, { x: 180, y: 20, width: 250, height: 100 });
                firstPage.drawImage(logo2Image, { x: 190, y: 730, width: 200, height: 100 });
    
                const pageWidth = firstPage.getWidth();
                const pageHeight = firstPage.getHeight();
                const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
                const fontSize = 12;
    
                const alignRight = (text, y) => {
                    const textWidth = font.widthOfTextAtSize(text, fontSize);
                    const xPosition = pageWidth - textWidth - 50;
                    firstPage.drawText(text, { x: xPosition, y: y, size: fontSize, font: font });
                };
    
                // Dati paziente
                alignRight(`Sig.ra/Sig. ${name} ${surname}`, 640);
                alignRight(`Città di nascita: ${pob}`, 615);
                alignRight(`Data di nascita: ${dob}`, 590);
    
                firstPage.drawText("Si prescrivono i seguenti esami:", { x: 50, y: 560, size: fontSize, font: font });
    
                // Raccogli esami
                const listaEsamiElements = document.querySelectorAll("input.esame_nascosto");
                const esamiRaw = Array.from(listaEsamiElements).map(input => input.value.trim());
                let esami = esamiRaw.join(",").split(",").map(e => e.trim());
                esami = [...new Set(esami)];
    
                const maxEsamiPerPagina = 34;
    
                if (esami.length <= maxEsamiPerPagina) {
                    let y = 530;
                    for (const esame of esami) {
                        firstPage.drawText(`- ${esame}`, { x: 60, y: y, size: fontSize, font: font });
                        y -= 20;
                    }
                } else {
                    firstPage.drawText("Vedi esami in allegato", { x: 60, y: 530, size: fontSize, font: font });
    
                    let esamiIndex = 0;
                    let pageCount = 0;
    
                    while (esamiIndex < esami.length) {
                        const newPage = pdfDoc.addPage([pageWidth, pageHeight]);
                        let y = 750;
    
                        const title = pageCount === 0 ? "Elenco Esami:" : "Elenco Esami (continua):";
                        newPage.drawText(title, { x: 60, y: y, size: fontSize, font: font });
                        y -= 20;
    
                        for (let i = 0; i < maxEsamiPerPagina && esamiIndex < esami.length; i++, esamiIndex++) {
                            newPage.drawText(`- ${esami[esamiIndex]}`, { x: 60, y: y, size: fontSize, font: font });
                            y -= 20;
                        }
    
                        pageCount++;
                    }
                }
    
                // Diagnosi e firma
                firstPage.drawText("Diagnosi:", { x: 50, y: 300, size: fontSize, font: font });
    
                const today = new Date();
                const formattedDate = today.toLocaleDateString('it-IT', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
    
                firstPage.drawText(`Bari, ${formattedDate}`, { x: 50, y: 200, size: fontSize, font: font });
    
                const text = "Dott. Luigi Aprile:";
                const textWidth = font.widthOfTextAtSize(text, fontSize);
                const xPosition = pageWidth - textWidth - 50;
                firstPage.drawText(text, { x: xPosition, y: 150, size: fontSize, font: font });
    
                // Salva e scarica PDF
                const modifiedPdfBytes = await pdfDoc.save();
                const blob = new Blob([modifiedPdfBytes], { type: "application/pdf" });
    
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = fileName;
                link.click();
    
            } catch (error) {
                console.error("Errore nella generazione del PDF:", error);
            }
        }
    
        // Esempio di chiamata
        generatePDF(
            "/static/includes/pdfTemplates/prescrizioneTemplate.pdf",
            "/static/includes/pdfTemplates/logo.png",
            "/static/includes/pdfTemplates/logo2.png",
            "{{ persona.name }}",
            "{{ persona.surname }}",
            "{{ persona.dob }}",
            "{{ persona.pob }}",
            "{{ persona.name }}_{{ persona.surname }}.pdf"
        );
    
    </script>

    <!-- MODALE PRESCRIZIONE FARMACI -->
    <!-- DOCX -->
    <!-- <script>
            
        async function generatePDF() {

            try {
                const existingPdfBytes = await fetch('/static/includes/pdfTemplates/prescrizioneTemplate.pdf').then((res) => res.arrayBuffer());
                const pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes);
                const firstPage = pdfDoc.getPages()[0];

                const logoUrl = "/static/includes/pdfTemplates/logo.png";
                const logo2Url = "/static/includes/pdfTemplates/logo2.png";

                const logoImageBytes = await fetch(logoUrl).then(res => res.arrayBuffer());
                const logo2ImageBytes = await fetch(logo2Url).then(res => res.arrayBuffer());

                const logoImage = await pdfDoc.embedPng(logoImageBytes);
                const logo2Image = await pdfDoc.embedPng(logo2ImageBytes);


                firstPage.drawImage(logoImage, { x: 180, y: 20, width: 250, height: 140 });
                firstPage.drawImage(logo2Image, { x: 190, y: 730, width: 200, height: 100 });


                const pageWidth = firstPage.getWidth();
                const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
                const fontSize = 12;

                const alignRight = (text, y) => {
                    const textWidth = font.widthOfTextAtSize(text, fontSize);
                    const xPosition = pageWidth - textWidth - 50;
                    firstPage.drawText(text, { x: xPosition, y: y, size: fontSize, font: font });
                };

                const persona = {
                    name: "{{ persona.name }}",
                    surname: "{{ persona.surname }}",
                    pob: "{{ persona.pob }}",
                    dob: "{{ persona.dob }}"
                };

                alignRight(`Sig.ra/Sig. ${persona.name} ${persona.surname}`, 640);
                alignRight(`Città di nascita: ${persona.pob}`, 615);
                alignRight(`Data di nascita: ${persona.dob}`, 590);


                firstPage.drawText("Si prescrivono i seguenti esami:", { x: 50, y: 560, size: fontSize, font: font });
                firstPage.drawText("Diagnosi:", { x: 50, y: 300, size: fontSize, font: font });

                const today = new Date();
                const formattedDate = today.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' });

                firstPage.drawText(`Bari, ${formattedDate}`, { x: 50, y: 200, size: fontSize, font: font });

                const text = "Dott. Luigi Aprile:";
                const textWidth = font.widthOfTextAtSize(text, fontSize);
                const xPosition = pageWidth - textWidth - 50;
                firstPage.drawText(text, { x: xPosition, y: 150, size: fontSize, font: font });


                const modifiedPdfBytes = await pdfDoc.save();
                const blob = new Blob([modifiedPdfBytes], { type: "application/pdf" });


                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `${persona.name}_${persona.surname}.pdf`;
                link.click();

            }
            catch (error) {
                    console.error("Errore nella generazione del PDF:", error);
            }
        }

        const downloadButton = document.getElementById('downloadPrescrizioneVuota')
        downloadButton.addEventListener("click", generatePDF);


    </script> 
 -->
   
 
    <!-- MODALE -->
    <script>
        function closeModal(){
            document.getElementById('modalePrescrizioni').style.display = 'none';
            document.getElementById('backdropPrescrizioni').style.display = 'none';
        }
    </script>
    




    <script src="https://cdn.jsdelivr.net/npm/docx@7.7.0/build/index.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.0.2/docx.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>