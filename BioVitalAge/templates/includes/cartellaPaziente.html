{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <!-- Favicon -->
    <link rel="sortcut icon" href='{% static "includes/icone/favicon.png" %}' type="image/x-icon">

    <title>Cartella Paziente</title>

    <!-- Css Import -->
    <link rel="stylesheet" href="{% static 'includes/css/Componenti.css' %}">
    <link rel="stylesheet" href="{% static 'includes/css/cartellaPaziente.css' %}">
    <link rel="stylesheet" href="{% static 'includes/css/homePage.css' %}">

    <!-- Bootstrap import -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Import  -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300..700&display=swap" rel="stylesheet">

    <!-- JS IMPORT -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://unpkg.com/libphonenumber-js/bundle/libphonenumber-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.16.0/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
</head>

<body>
    <!-- Loader -->
    {% include 'components/loader.html' %}

    <!-- NAVBAR -->
    {% include 'components/navBar.html' %}


    <main>
        <!-- MENU TRACE -->
        <div class="main-title-nav">
            <div class="back-tittle">
                <a id="back" href="{% url 'Risultati' %}"><img src="{% static 'includes/icone/arrowBack.png' %}"></a>
                <h2 class="main-welcome-title">
                    <span>{{ persona.surname|title }}</span>
                    <span>{{ persona.name|title }}</span> |
                    <span>Età: {{ persona.chronological_age }}</span>
                    {% if persona.phone and persona.email %}
                    |
                    <span class="phone_span">
                        <img src="{% static 'includes/icone/phone.png' %}" width="20px" height="20px">
                        Telefono: {{ persona.phone }}
                    </span> |
                    <span class="email_span">
                        <img src="{% static 'includes/icone/emailNew.png' %}" width="20px" height="20px">
                        Email: {{ persona.email }}
                    </span>
                    {% endif %}
                </h2>
            </div>
        
            <div class="main-menu-trace">
                <a href="{% url 'HomePage' %}">
                    <img src="{% static 'includes/icone/homePage.png' %}" alt="Home Page" title="Home Page" />
                </a>
                <p>»</p>
                <p>
                    <a href="{% url 'Risultati' %}">Pazienti</a>
                </p>
                <p>»</p>
                <p>Cartella Paziente</p>
            </div>
        
        </div>  

        <!-- MESSAGGIO DI SUCCESSO CON PUNTEGGIO -->
        {% if success %}
        <div class="success_message" id="modal_message">

            <div class="header_message">
                <div class="contianer-title">
                    <img src="{% static 'includes/images/success.png' %}" alt="">
                    <p class="title_message">Success!</p>
                </div>
                <button class="close" onclick="closeModal()">x</button>
                
            </div>

            <p>I dati delle informazioni personali sono state correttamente aggiornate!</p>

        </div>  
        {% endif %}

        <!-- MESSAGGIO ERRORE -->
        {% if errore %}
        <div class="erorre_message" id="modal_message">
 
                <div class="header_message">
                    <div class="contianer-title">
                        <img src="{% static 'includes/images/unsuccess.png' %}" alt="">
                        <p class="title_message_errore">Errore!</p>
                    </div>
                    <button class="close" onclick="closeModal()">x</button>
                    
                </div>
                <p>Sembra che qualcosa sia andato storto.</p>
                <p style="margin-top: -1rem; color: #c74b5b; font-weight: bold;">X {{ errore }}</p>
            
        </div>
        {% endif %}


        <!-- CARD PERSONAL INFORMATION -->
        <div class="container-datiPersonali containerStyle">

            <form id="personaForm" method="POST" action="{% url 'cartella_paziente' persona.id %}">
                {% csrf_token %}
                
                <div class="header-card">
                    <div class="container-titolo">
                        <img src="{% static 'includes/images/info.png' %}" alt="">
                        <h3>Informazioni Personali</h3>
                    </div>
            
                    <div class="button-grid">
                        <a href="#"><img src="{% static 'includes/icone/note.png' %}" alt="Note" title="Note"></a>
            
                        <a href="{% static 'includes/pdfTemplates/Privacy&Policy.pdf' %}" download class="privacy-icon">
                            <img src="data:image/png;base64,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"
                                alt="data-protection" title="Privacy & Policy">
                        </a>      
            
                        <!-- Il pulsante modifica, ora con un wrapper span per il testo -->
                        <a class="Btn-modify" title="Modifica">
                            <span class="btn-text">Edita</span>
                            <svg class="svg" viewBox="0 0 512 512">
                                <path d="M410.3 231l11.3-11.3-33.9-33.9-62.1-62.1L291.7 89.8l-11.3 11.3-22.6 22.6L58.6 322.9c-10.4 10.4-18 23.3-22.2 37.4L1 480.7c-2.5 8.4-.2 17.5 6.1 23.7s15.3 8.5 23.7 6.1l120.3-35.4c14.1-4.2 27-11.8 37.4-22.2L387.7 253.7 410.3 231zM160 399.4l-9.1 22.7c-4 3.1-8.5 5.4-13.3 6.9L59.4 452l23-78.1c1.4-4.9 3.8-9.4 6.9-13.3l22.7-9.1v32c0 8.8 7.2 16 16 16h32zM362.7 18.7L348.3 33.2 325.7 55.8 314.3 67.1l33.9 33.9 62.1 62.1 33.9 33.9 11.3-11.3 22.6-22.6 14.5-14.5c25-25 25-65.5 0-90.5L453.3 18.7c-25-25-65.5-25-90.5 0zm-47.4 168l-144 144c-6.2 6.2-16.4 6.2-22.6 0s-6.2-16.4 0-22.6l144-144c6.2-6.2 16.4-6.2 22.6 0s6.2 16.4 0 22.6z"></path>
                            </svg>
                        </a>
            
                        <button type="button" class="button button-view-all">
                            <span class="button__icon-wrapper">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" width="18" class="button__icon-svg">
                                    <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                                </svg>
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" width="18" class="button__icon-svg button__icon-svg--copy">
                                    <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                                </svg>
                            </span>
                            Mostra di più
                        </button>
                    </div>
                </div>
            
                <div class="container_box">
                    <div class="grid-container">
                        <!-- Esempio di input: assicurati che ogni input abbia un name appropriato -->
                        <div class="field">
                            <p class="field-title">Codice Fiscale:</p>
                            <input class="input-disabled" type="text" name="codice_fiscale" value="{{ persona.codice_fiscale|default:'non inserito' }}" placeholder="inserisci il valore" disabled>
                        </div>
            
                        <div class="field">
                            <p class="field-title">Data di Nascita:</p>
                            <input class="input-disabled" type="text" name="dob" value="{{ persona.dob|date:'d/m/Y'|default:'non inserito' }}" placeholder="inserisci il valore" disabled>
                        </div>
            
                        <div class="field">
                            <p class="field-title">Città di nascita:</p>
                            <input class="input-disabled" type="text" name="place_of_birth" value="{{ persona.place_of_birth|title|default:'non inserito' }}" placeholder="inserisci il valore" disabled>
                        </div>
            
                        <!-- Altri campi... -->
                        <div class="field">
                            <p class="field-title">Città di residenza:</p>
                            <input class="input-disabled" type="text" name="residence" value="{{ persona.residence|title|default:'non inserito' }}" placeholder="inserisci il valore" disabled>
                        </div>
            
                        <div class="field">
                            <p class="field-title">CAP:</p>
                            <input class="input-disabled" type="text" name="cap" value="{{ persona.cap|default:'non inserito' }}" placeholder="inserisci il valore" disabled>
                        </div>
            
                        <div class="field">
                            <p class="field-title">Provincia:</p>
                            <input class="input-disabled" type="text" name="province" value="{{ persona.province|default:'non inserito' }}" placeholder="inserisci il valore" disabled>
                        </div>
            
                        <div class="field">
                            <p class="field-title">Genere:</p>
                            <input class="input-disabled" type="text" name="gender" value="{{ persona.gender|default:'non inserito' }}" placeholder="inserisci il valore" disabled>
                        </div>
                    </div>
            
                    <div class="other_container">
                        <div class="subCard-container">
                            <div class="card-subcard">
                                <div class="img-circle-container">
                                    <img src="{% static 'includes/icone/stetoscopio.png' %}" alt="">
                                </div>
                                <div class="container-input-info">
                                    <p>Dottore Associato</p>
                                    <input class="input-disabled type-two" type="text" name="associate_staff" value="{{ persona.associate_staff|default:persona.dottore }}" placeholder="inserisci il valore" disabled>
                                </div>
                            </div>
            
                            <div class="card-subcard">
                                <div class="img-circle-container">
                                    <img src="{% static 'includes/icone/ospedale.png' %}" alt="">
                                </div>
                                <div class="container-input-info">
                                    <p>Visita Recente</p>
                                    <input class="input-disabled type-two" type="text" name="lastVisit" value="{{ persona.lastVisit|date:'d/m/Y'|default:'non inserito' }}" placeholder="inserisci il valore" disabled>
                                </div>
                            </div>
            
                            <div class="card-subcard">
                                <div class="img-circle-container">
                                    <img src="{% static 'includes/icone/calendario.png' %}" alt="">
                                </div>
                                <div class="container-input-info">
                                    <p>Prossima Visita</p>
                                    <input class="input-disabled type-two" type="text" name="upcomingVisit" value="{{ persona.upcomingVisit|date:'d/m/Y'|default:'non inserito' }}" placeholder="inserisci il valore" disabled>
                                </div>
                            </div>
            
                            <div class="card-subcard">
                                <div class="img-circle-container">
                                    <img src="{% static 'includes/icone/blood.png' %}" alt="">
                                </div>
                                <div class="container-input-info">
                                    <p>Gruppo Sanguigno</p>
                                    <input class="input-disabled type-two" type="text" name="blood_group" value="{{ persona.blood_group|default:'non inserito' }}" placeholder="inserisci il valore" disabled>
                                </div>
                            </div>
                        </div>
            
                        <div class="Contact-Container">
                            <div class="card-subcard">
                                <div class="img-circle-container">
                                    <img src="{% static 'includes/icone/emailNew.png' %}" alt="">
                                </div>
                                <div class="container-input-info">
                                    <p>Email</p>
                                    <input class="input-disabled type-two" type="text" name="email" value="{{ persona.email|default:'non inserito' }}" placeholder="inserisci il valore" disabled>
                                </div>
                            </div>
            
                            <div class="card-subcard">
                                <div class="img-circle-container">
                                    <img src="{% static 'includes/icone/phone.png' %}" alt="">
                                </div>
                                <div class="container-input-info">
                                    <p>Telefono</p>
                                    <input class="input-disabled type-two" type="text" name="phone" value="{{ persona.phone|default:'non inserito' }}" placeholder="inserisci il valore" disabled>
                                </div>
                            </div>
                        </div>
                    </div>
            
                </div>
            </form>
        </div>


        <!-- CARD CLOCK -->
        <div class="container-indicatori containerStyle" style="margin-top: 0rem;">
            <div class="card card4" id="card-style">
                <h3 class="section-tittle" style="padding-top: 20px;">Indicatori di performance</h3>

                <div class="score-clock-graph">
    
                    <div class="container-clock">

                        <svg class="progress-ring" width="140" height="140">
                            <circle class="progress-ring__background" cx="70" cy="70" r="65"></circle>
                            <circle class="progress-ring__progress" id="heartClock" cx="70" cy="70" r="65"></circle>
                        </svg>
                       
                           
                        <div class="percentage" id="heartPercentage"></div>
                        
                        <div class="descrizione-clock">
                            <img src="{% static 'includes/images/saluteCuore.png' %}" alt="">
                            <p>Salute del Cuore</p>
                        </div>
                    </div>
                
                    <div class="container-clock">

                        <svg class="progress-ring" width="140" height="140">
                            <circle class="progress-ring__background" cx="70" cy="70" r="65"></circle>
                            <circle class="progress-ring__progress" id="kidneyClock" cx="70" cy="70" r="65"></circle>
                        </svg>
                    
                        <div class="percentage" id="kidneyPercentage"></div>
                       
                        <div class="descrizione-clock">
                            <img src="{% static 'includes/images/reni.png' %}" alt="">
                            <p>Salute Renale</p>
                        </div>
                    </div>
                
                    <div class="container-clock">
                        <svg class="progress-ring" width="140" height="140">
                            <circle class="progress-ring__background" cx="70" cy="70" r="65"></circle>
                            <circle class="progress-ring__progress" id="liverClock" cx="70" cy="70" r="65"></circle>
                        </svg>

                        <div class="percentage" id="liverPercentage"></div>
                      
                        <div class="descrizione-clock">
                            <img src="{% static 'includes/images/fegato.png' %}" alt="">
                            <p>Salute Epatica</p>
                        </div>
                    </div>
                
                    <div class="container-clock">
                        <svg class="progress-ring" width="140" height="140">
                            <circle class="progress-ring__background" cx="70" cy="70" r="65"></circle>
                            <circle class="progress-ring__progress" id="brainClock" cx="70" cy="70" r="65"></circle>
                        </svg>

                        <div class="percentage" id="brainPercentage"></div>
                       
                        <div class="descrizione-clock">
                            <img src="{% static 'includes/images/cervello.png' %}" alt="">
                            <p>Salute Cerebrale</p>
                        </div>
                    </div>
                
                    <div class="container-clock">
                        <svg class="progress-ring" width="140" height="140">
                            <circle class="progress-ring__background" cx="70" cy="70" r="65"></circle>
                            <circle class="progress-ring__progress" id="hormoneClock" cx="70" cy="70" r="65"></circle>
                        </svg>

                        <div class="percentage" id="hormonePercentage"></div>
                        
                        <div class="descrizione-clock">
                            <img src="{% static 'includes/images/cellula.png' %}" alt="">
                            <p>Salute Ormonale</p>
                        </div>
                    </div>
                
                    <div class="container-clock">
                        <svg class="progress-ring" width="140" height="140">
                            <circle class="progress-ring__background" cx="70" cy="70" r="65"></circle>
                            <circle class="progress-ring__progress" id="bloodClock" cx="70" cy="70" r="65"></circle>
                        </svg>

                        <div class="percentage" id="bloodPercentage"></div>
                        
                        <div class="descrizione-clock">
                            <img src="{% static 'includes/images/sangue.png' %}" alt="">
                            <p>Salute del Sangue</p>
                        </div>
                    </div>
                
                    <div class="container-clock" style="gap: 15px;">
                        <svg class="progress-ring" width="140" height="140">
                            <circle class="progress-ring__background" cx="70" cy="70" r="65"></circle>
                            <circle class="progress-ring__progress" id="immuneClock" cx="70" cy="70" r="65"></circle>
                        </svg>

                        <div class="percentage" id="immunePercentage" style="margin-top: 5px;"></div>
                     
                        <div class="descrizione-clock" style="margin-bottom: -14px;">
                            <img src="{% static 'includes/images/sistema.png' %}" alt="">
                            <p style="max-width: 60%; font-size: 14px;">Salute del Sistema Immunitario</p>
                        </div>
                    </div>
                
                    <div class="container-clock" style="gap: 15px;">
                        <svg class="progress-ring" width="140" height="140">
                            <circle class="progress-ring__background" cx="70" cy="70" r="65"></circle>
                            <circle class="progress-ring__progress" id="muscleClock" cx="70" cy="70" r="65"></circle>
                        </svg>

                        <div class="percentage" id="musclePercentage" style="margin-top: 5px;"></div>
                   
                        <div class="descrizione-clock" style="margin-bottom: -14px;">
                            <img src="{% static 'includes/images/muscolo.png' %}" alt="">
                            <a href="{% url 'valutazione_m_s' persona.id %}" style="width: 60%; text-decoration: none;"> 
                                <p style="font-size: 14px;">Salute Muscolo-scheletrica</p>
                            </a>
                        </div>
                    </div>
                </div>

                <div class="container-second-row">

                    <div class="capacita_vitale" data-punteggio="{{ ultimo_referto_capacita_vitale.punteggio|default:'2' }}">
                        <h3>Capacità Vitale</h3>

                        
                        <div class="card-polmone">
                            <div class="backdrop-riempimento">
                                <svg class="ondina" viewBox="0 0 500 100" preserveAspectRatio="none">
                                    <path class="wavePath" d="M0,30 C150,80 350,0 500,40 L500,100 L0,100 Z" />
                                </svg>
                            </div>
                            
                            <img src="{% static 'includes/icone/cVitale.png' %}" alt="" width="120px" height="120px">
                        </div>
                          
                        <p class="descrizione-vitale"><span style="font-weight: bold;">Punteggio: &nbsp; </span>{{ ultimo_referto_capacita_vitale.punteggio|default:'n.a.' }} / 10</p>

                    </div>

                    <div class="capacita_vitale" data-punteggio="{{ referti_test_recenti.resilienza|default:'2' }}">
                        <h3>Resilienza</h3>
                        <div class="card-polmone">
                            <div class="backdrop-riempimento">
                                <svg class="ondina" viewBox="0 0 500 100" preserveAspectRatio="none">
                                    <path class="wavePath" d="M0,30 C150,80 350,0 500,40 L500,100 L0,100 Z" />
                                </svg>
                            </div>
                            <img src="{% static 'includes/icone/forza.png' %}" alt="" width="120px" height="120px">
                        </div>
                        <p class="descrizione-vitale"><strong>Punteggio:</strong> {{ referti_test_recenti.resilienza|default:'n.a.' }}</p>
                    </div>

                    <div class="eta-container">
                        <h3>Età Biologica</h3>  
                 
                        <script>
                            document.addEventListener("DOMContentLoaded", function () {
                                const crono = document.getElementById('crono');
                                const biologica = document.getElementById('biologica');
                            
                                if (crono && biologica) {
                                    const percentuale_crono = parseInt(crono.textContent);
                                    const percentuale_biologica = parseInt(biologica.textContent); 
                            
                                    const div_crono = document.querySelector('.cronologic-age');
                                    const div_biologica = document.querySelector('.biologic-age');
                            
                                    div_crono.style.left = `${percentuale_crono}%`;
                                    div_biologica.style.left = `${percentuale_biologica}%`;
                            
                                  
                                    if (percentuale_biologica < percentuale_crono) {
                                        div_biologica.classList.add('freccia-up');
                                    } else if (percentuale_biologica > percentuale_crono) {
                                        div_biologica.classList.add('freccia-down');
                                    } else {
                                        div_biologica.classList.add('freccia-equal');
                                    }
                                } else {
                                    console.warn("Elemento 'crono' o 'biologica' non trovato nel DOM.");
                                }
                            });
                        </script>
                                
                        <div class="lineaContainer">
                           <p class="estremoInferiore">0</p>

                            <div class="cronologic-age">
                                <img src="{% static 'includes/icone/età_crono.png' %}" alt="">
                                <p id="crono">{{ persona.chronological_age }}</p>      
                            </div>
                            
                            <div class="biologic-age">
                                <img src="{% static 'includes/icone/eta_biologica.png' %}" alt="" style="margin-top: 15px;"> 
                                <p id="biologica" style="margin-top: 5px; margin-bottom: 0px;">{{ dati_estesi_ultimo_referto.biological_age }}</p>
                            </div>

                            <p class="estremoSuperiore">100</p>
                        </div>

                        <div class="legenda">
                            <div class="subcontainer-legenda">
                                <img src="{% static 'includes/icone/eta_biologica.png' %}" alt="">
                                <p>Età Biologica</p>
                            </div>
                        
                            <div class="subcontainer-legenda">
                                <img src="{% static 'includes/icone/età_crono.png' %}" alt="" >
                                <p>Età Cronologica</p>
                            </div>
                        </div>
                    </div>      

                    <div class="capacita_vitale" data-punteggio="{{ punteggio_eta_metabolica|default:'2' }}">
                        <h3>Età Metabolica</h3>
                        <div class="card-polmone">
                            <div class="backdrop-riempimento">
                                <svg class="ondina" viewBox="0 0 500 100" preserveAspectRatio="none">
                                    <path class="wavePath" d="M0,30 C150,80 350,0 500,40 L500,100 L0,100 Z" />
                                </svg>
                            </div>
                            <img src="{% static 'includes/icone/metabolica.png' %}" alt="" width="120px" height="120px">
                        </div>
                        <p class="descrizione-vitale"><strong>Punteggio:</strong> {{ punteggio_eta_metabolica|default:'n.a.' }} / 100</p>
                    </div>

                    <div class="capacita_vitale" data-punteggio="{{ referti_test_recenti.microbiota|default:'2' }}">
                        <h3>Microbiota</h3>
                        <div class="card-polmone">
                            <div class="backdrop-riempimento">
                                <svg class="ondina" viewBox="0 0 500 100" preserveAspectRatio="none">
                                    <path class="wavePath" d="M0,30 C150,80 350,0 500,40 L500,100 L0,100 Z" />
                                </svg>
                            </div>
                            <img src="{% static 'includes/icone/microbiota.png' %}" alt="" width="120px" height="120px">
                        </div>
                        <p class="descrizione-vitale"><strong>Punteggio:</strong> {{ referti_test_recenti.microbiota|default:'n.a.' }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- CARD SEZIONI DATI BASE E COMPOSIZIONE CORPOREA -->
        <div class="container-sezioniInterne containerStyle"  style="margin-top: -1rem;">
            <div class="cardDati">

             
                <div class="cartella-effect">
                    <h3>Dati Base - Stile di Vita Paziente</h3>
                    <div class="space"></div>
                </div>


                <div class="card-content">
                    <img src="{% static 'includes/images/datiBase3.png' %}" alt="">
                    <p> In questa sezione è possibile inserire informazioni inerenti le abitudini e lo stile di vita del paziente (fumo,
                        alcol, attività fisica).
                    </p>
                    <a href="{% url 'dati_base' persona.id %}">Vai alla sezione</a>
                </div>
            </div>


            <div class="cardDati">
                <div class="cartella-effect">
                    <h3>Età Metabolica</h3>
                    <div class="space"></div>
                </div>
                <div class="card-content">
                    <img src="{% static 'includes/images/composizione1.webp' %}" alt="">
                    <p>In questa sezione è possibile inserire informazioni inerenti la composizione corporea del paziente, per una
                        valutazione del suo stato di salute fisica.</p>
                    <a href="{% url 'composizione' persona.id %}">Vai alla sezione</a>
                </div>
            </div>
        </div>

        <!-- CARD SEZIONI ETA VITALE E ETA BIOLOGICA -->
        <div class="container-sezioniInterne containerStyle" style="margin-top: -1rem;">
            <div class="cardDati">

                <div class="cartella-effect">
                    <h3>Capacità Vitale</h3>
                    <div class="space"></div>
                </div>


                <div class="card-content">
                    <img src="{% static 'includes/images/vitale.png' %}" alt="">
                    <p>In questa sezione è possibile calcolare un punteggio relativo alla capacità vitale del paziente, sulla base delle
                        informazioni ricavate mediante questionari e prove fisiche.
                    </p>
                    <a href="{% url 'etaVitale' persona.id %}">Vai alla sezione</a>
                </div>
            </div>

            <!-- ETA BIOLOGICA -->
            <div class="cardDati">
                <div class="cartella-effect">
                    <h3>Rapporto Età Biologica</h3>
                    <div class="space"></div>
                </div>
                <div class="card-content">
                    <img src="{% static 'includes/images/biologica.png' %}" alt="">
                    <p style="top: 4rem;">Referti Età Biologica</p>
                    <p style="top: 6rem;"><strong>Ultimo Calcolo:</strong> &nbsp; {{ ultimo_referto.data_referto|date:"d/m/Y" }} </p>
                    <a href="{% url 'elenco_referti' persona.id %}" style="top: 10rem;" id="adjust">Vai ai referti</a>
                    <a href="{% url 'Calcolatore' persona.id %}?parametro={{ persona.codice_fiscale|urlencode }}">
                        Calcola l'età biologica
                    </a>
                    
                </div>
            </div>
        </div>

        <!-- CARD SEZIONI RESILIENZA E THERAPY -->
        <div class="container-sezioniInterne containerStyle" style="margin-top: -1rem;">
            
            <!-- RESILIENZA -->
            <div class="cardDati">

                <div class="cartella-effect">
                    <h3>Resilienza</h3>
                    <div class="space"></div>
                </div>


                <div class="card-content">
                    <img src="{% static 'includes/images/Resilienza.png' %}" alt="">
                    <p>Lorem ipsum dolor sit amet consectetur, adipisicing elit. Aspernatur exercitationem placeat impedit mollitia dolor est nesciunt enim in libero repellat temporibus voluptatum esse adipisci, maiores expedita eaque nulla architecto nihil!
                    </p>
                    <a href="{% url 'resilienza' persona.id %}">Vai alla sezione</a>
                </div>
            </div>

            <!-- TERAPHY -->
            <div class="cardDati">
                <div class="cartella-effect">
                    <h3>Piano Terapeutico</h3>
                    <div class="space"></div>
                </div>
                <div class="card-content">
                    <img src="{% static 'includes/images/teraphy1.png' %}" alt="">
                    <p>Lorem ipsum, dolor sit amet consectetur adipisicing elit. Ipsum impedit velit libero perspiciatis. Qui, a nihil earum quasi impedit praesentium quia temporibus magnam modi minima libero delectus nam repudiandae amet?
                    </p>
                    <a href="{% url 'piano_terapeutico' persona.id %}">Vai alla sezione</a>
                </div>
            </div>
        </div>
        
        
        <script src="https://cdn.jsdelivr.net/npm/docx@7.7.0/build/index.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.0.2/docx.min.js"></script>

        <!-- FUNZION PDF VUOTO PRESCRIZIONE -->
        <script>
            
            async function generatePDF() {

                try {
                    const existingPdfBytes = await fetch('/static/includes/pdfTemplates/prescrizioneTemplate.pdf').then((res) => res.arrayBuffer());
                    const pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes);
                    const firstPage = pdfDoc.getPages()[0];

                    const logoUrl = "/static/includes/pdfTemplates/logo.png";
                    const logo2Url = "/static/includes/pdfTemplates/logo2.png";

                    const logoImageBytes = await fetch(logoUrl).then(res => res.arrayBuffer());
                    const logo2ImageBytes = await fetch(logo2Url).then(res => res.arrayBuffer());

                    const logoImage = await pdfDoc.embedPng(logoImageBytes);
                    const logo2Image = await pdfDoc.embedPng(logo2ImageBytes);


                    firstPage.drawImage(logoImage, { x: 180, y: 20, width: 250, height: 140 });
                    firstPage.drawImage(logo2Image, { x: 190, y: 730, width: 200, height: 100 });


                    const pageWidth = firstPage.getWidth();
                    const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
                    const fontSize = 12;

                    const alignRight = (text, y) => {
                        const textWidth = font.widthOfTextAtSize(text, fontSize);
                        const xPosition = pageWidth - textWidth - 50;
                        firstPage.drawText(text, { x: xPosition, y: y, size: fontSize, font: font });
                    };

                    const persona = {
                        name: "{{ persona.name }}",
                        surname: "{{ persona.surname }}",
                        pob: "{{ persona.pob }}",
                        dob: "{{ persona.dob }}"
                    };

                    alignRight(`Sig.ra/Sig. ${persona.name} ${persona.surname}`, 640);
                    alignRight(`Città di nascita: ${persona.pob}`, 615);
                    alignRight(`Data di nascita: ${persona.dob}`, 590);


                    firstPage.drawText("Si prescrivono i seguenti esami:", { x: 50, y: 560, size: fontSize, font: font });
                    firstPage.drawText("Diagnosi:", { x: 50, y: 300, size: fontSize, font: font });

                    const today = new Date();
                    const formattedDate = today.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' });

                    firstPage.drawText(`Bari, ${formattedDate}`, { x: 50, y: 200, size: fontSize, font: font });

                    const text = "Dott. Luigi Aprile:";
                    const textWidth = font.widthOfTextAtSize(text, fontSize);
                    const xPosition = pageWidth - textWidth - 50;
                    firstPage.drawText(text, { x: xPosition, y: 150, size: fontSize, font: font });


                    const modifiedPdfBytes = await pdfDoc.save();
                    const blob = new Blob([modifiedPdfBytes], { type: "application/pdf" });


                    const link = document.createElement("a");
                    link.href = URL.createObjectURL(blob);
                    link.download = `${persona.name}_${persona.surname}.pdf`;
                    link.click();

                }
                catch (error) {
                        console.error("Errore nella generazione del PDF:", error);
                }
            }

            const downloadButton = document.getElementById('downloadPrescrizioneVuota')
            downloadButton.addEventListener("click", generatePDF);


        </script> 

        {% if pdf_url %}

        <!-- FUNZION STAMPA PDF PRESCRIZIONI -->
       
        <script>
            document.addEventListener("DOMContentLoaded", () => {
                const wave1 = "M0,40 C150,100 350,-20 500,60 L500,100 L0,100 Z";
                const wave2 = "M0,60 C150,40 350,120 500,30 L500,100 L0,100 Z";
            
                document.querySelectorAll(".capacita_vitale").forEach(card => {
                    const punteggio = parseFloat(card.dataset.punteggio || "0");
                    const percentuale = Math.min((punteggio / 10) * 100, 100); // sicurezza: max 100%
                    
                    const backdrop = card.querySelector(".backdrop-riempimento");
                    const wavePath = card.querySelector(".wavePath");
            
                    // Animazione onda
                    gsap.to(wavePath, {
                        duration: 2,
                        repeat: -1,
                        yoyo: true,
                        ease: "sine.inOut",
                        attr: { d: wave2 }
                    });
            
                    // Riempimento acqua
                    gsap.to(backdrop, {
                        duration: 1.8,
                        height: `${percentuale}%`,
                        ease: "power2.out"
                    });
                });
            });
        </script>
    
        {% endif %}

        <!-- CARD BP, SUGAR, HEART, CHOLESTEROL -->
        <div class="dashboard">

            <div class="card-graphic" id="card-style">
                <div class="icon">
                    <img src="{% static 'includes/icone/pillola.png' %}" alt="BP Levels Icon">
                </div>
                <h3>Livello BP</h3>
                <p>Ultime 5 visite</p>
                <div class="container_chart_dashboard">
                    <canvas id="chart1"></canvas>
                </div>
                <div class="data">
                    <table>
                        <tr>
                            <td>24/04/2024</td>
                            <td>140</td>
                        </tr>
                        <tr>
                            <td>16/04/2024</td>
                            <td>190</td>
                        </tr>
                        <tr>
                            <td>10/04/2024</td>
                            <td>230</td>
                        </tr>
                    </table>
                </div>
            </div>

            <div class="card-graphic" id="card-style">
                <div class="icon">
                    <img src="{% static 'includes/icone/sugar.png' %}" alt="Sugar Levels Icon">
                </div>
                <h3>Livello di zuccheri</h3>
                <p>Ultime 5 visite</p>
                <div class="container_chart_dashboard">
                    <canvas id="chart2"></canvas>
                </div>
                <div class="data">
                    <table>
                        <tr>
                            <td>24/04/2024</td>
                            <td>140</td>
                        </tr>
                        <tr>
                            <td>16/04/2024</td>
                            <td>190</td>
                        </tr>
                        <tr>
                            <td>10/04/2024</td>
                            <td>230</td>
                        </tr>
                    </table>
                </div>
            </div>

            <div class="card-graphic" id="card-style">
                <div class="icon">
                    <img src="{% static 'includes/icone/heart.png' %}" alt="Heart Rate Icon">
                </div>
                <h3>Frequenza Cardiaca</h3>
                <p>Ultime 5 visite</p>
                <div class="container_chart_dashboard">
                    <canvas id="chart3"></canvas>
                </div>
                <div class="data">
                    <table>
                        <tr>
                            <td>24/04/2024</td>
                            <td>110</td>
                        </tr>
                        <tr>
                            <td>16/04/2024</td>
                            <td>120</td>
                        </tr>
                        <tr>
                            <td>10/04/2024</td>
                            <td>100</td>
                        </tr>
                    </table>
                </div>
            </div>

            <div class="card-graphic" id="card-style">
                <div class="icon">
                    <img src="{% static 'includes/icone/provetta.png' %}" alt="Cholesterol Icon">
                </div>
                <h3>Colesterolo</h3>
                <p>Ultime 5 visite</p>
                <div class="container_chart_dashboard">
                    <canvas id="chart4"></canvas>
                </div>
                <div class="data">
                    <table>
                        <tr>
                            <td>24/04/2024</td>
                            <td>180</td>
                        </tr>
                        <tr>
                            <td>16/04/2024</td>
                            <td>220</td>
                        </tr>
                        <tr>
                            <td>10/04/2024</td>
                            <td>230</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

    </main>


    <!-- IMPORT JS PRE DOBY CLOSE TAG -->
    <!--  CLOSE MODALE MESSAGE SUCCESS -->
    <script>
        function closeModal(){
            const modale = document.getElementById('modal_message');
            modale.style.display = 'none';
        }
    </script>

    <!-- SCRIPT CAPACITA' VITALE -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const wave1 = "M0,40 C150,100 350,-20 500,60 L500,100 L0,100 Z";
            const wave2 = "M0,60 C150,40 350,120 500,30 L500,100 L0,100 Z";
        
            document.querySelectorAll(".capacita_vitale").forEach(card => {
                // Ottieni il punteggio, oppure assegna 1 se mancante (10%)
                const punteggio = parseFloat(card.dataset.punteggio);
                const punteggioFinale = isNaN(punteggio) ? 1 : punteggio;
        
                // Se il punteggio è maggiore di 10, è in base 100, altrimenti in base 10
                const percentuale = punteggioFinale > 10 
                    ? Math.min(punteggioFinale, 100) 
                    : Math.min((punteggioFinale / 10) * 100, 100);
        
                const backdrop = card.querySelector(".backdrop-riempimento");
                const wavePath = card.querySelector(".wavePath");
        
                if (!wavePath || !backdrop) return;
        
                // Animazione ondina
                gsap.to(wavePath, {
                    duration: 2,
                    repeat: -1,
                    yoyo: true,
                    ease: "sine.inOut",
                    attr: { d: wave2 }
                });
        
                // Altezza riempimento
                gsap.to(backdrop, {
                    duration: 1.8,
                    height: `${percentuale}%`,
                    ease: "power2.out"
                });
            });
        });
    </script>
        

    <script src="{% static 'includes/js/cartellaPaziente.js' %}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>