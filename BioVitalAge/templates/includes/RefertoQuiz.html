{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Favicon -->
    <link rel="shortcut icon" href='{% static "includes/icone/favicon.png" %}' type="image/x-icon">

    <title>BioVitalAge - Report</title>

    <!-- Css Import -->
    <link rel="stylesheet" href="{% static 'includes/css/Referto.css' %}">
    <link rel="stylesheet" href="{% static 'includes/css/Componenti.css' %}">

    <!-- Js Import  -->
    <script src="{% static 'includes/js/indicatorNew.js' %}" defer></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="{% static 'includes/js/GeneratorePDF.js' %}" defer></script>
    <script src="{% static 'includes/js/spinner.js' %}" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <!-- Bootstrap import -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Import  -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300..700&display=swap" rel="stylesheet">
   
    <!-- Js librerie Import -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
</head>
<body>
    <!-- Loader -->
    {% include 'components/loader.html' %}

    <!-- NAVBAR -->
    {% include 'components/navBar.html' %}

    <!-- Disclaimer Modal -->
    <div id="pdfDisclaimerModal" class="modal-pdf-container hidden">
        <div class="modal-pdf-content">
            <h2>Avviso Importante</h2>
            <p>
                Scaricando il PDF, confermi di accettare che i dati sensibili contenuti saranno gestiti in conformità alle
                normative vigenti in materia di privacy, incluse le disposizioni del GDPR (Regolamento UE 2016/679).
            </p>
            <button id="closeDisclaimerBtn" class="btn-pdf-close">Chiudi</button>
        </div>
    </div>

    <main>
        <div class="main-title-nav">
            <div class="back-tittle">
                <a id="back" href="{% url 'etaVitale' persona.id %}"><img src="{% static 'includes/icone/arrowBack.png' %}"
                        alt="back_ico" title="Back to Results"></a>
                <h2 class="main-welcome-title">Referto Capacità Vitale, {{ persona.name }} {{ persona.surname }}</h2>
            </div>
    
            <div class="main-menu-trace">
                <a href="{% url 'HomePage' %}">
                    <img src="{% static 'includes/icone/homePage.png' %}" alt="Home Page" title="Home Page" />
                </a>
                <p>»</p>
                <a href="{% url 'Risultati' %}">Elenco Pazienti</a>
                <p>»</p>
                <a href="{% url 'cartella_paziente' persona.id %}">Cartella Paziente</a>
                <p>»</p>
                <a href="{% url 'etaVitale' persona.id %}">Capacità BioVitale</a>
                <p>»</p>
                <p>Referto Capacità Biovitale</p>
            </div>
        </div>
    
        <!-- ANGRAFIC DATA -->
        <div class="container_data anagraphic_data stampa">
            <h3>Personal Information</h3>
            <div class="container_box">
                <div class="info_container">
                    <div class="field">
                        <p>Name:&nbsp;</p>
                        <p id="name">{{ persona.name }}</p>
                    </div>
    
                    <div class="field">
                        <p>Surname:&nbsp;</p>
                        <p id="surname">{{ persona.surname }}</p>
                    </div>
    
                    <div class="field">
                        <p>Fiscal Code:&nbsp;</p>
                        <p id="codice_fiscale">{{ persona.codice_fiscale }}</p>
                    </div>
    
                    <div class="field">
                        <p>Place of birth:&nbsp;</p>
                        <p id="place_birth">{{ persona.place_of_birth }}</p>
                    </div>
    
                    <div class="field">
                        <p>Age:&nbsp;</p>
                        <p id="chronological_age">{{ persona.chronological_age }}</p>
                    </div>
    
                    <div class="field">
                        <p>Date of birth:&nbsp;</p>
                        <p id="dob">{{ persona.dob }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- FUNZIONE MUSCOLARE -->
        <div class="container-box-score">
            <h3>Risultato del calcolo della Capacità Vitale</h3>
            <p>
                I dati del questionario vengono suddivisi in sezioni per le quali ogni sezione ha un punteggio finale calcolato,
                che vengono poi sommati per dare il risultato finale che sarà la capacità vitale. Le sezioni prese in considerazione 
                per il calcolo sono: Questionario del sistema immunitario, Questionario della stanchezza percepita, Energia e metabolismo,
                Questionario della Sarcopenia, funzione muscolare, performance fisica, biomarcatori circolanti dell'infiammazione,
                biomarcatori circolanti del metabolismo.
            </p>

            <div class="container-score">
                <div class="score-box" style="width: 100%;">
                    <div class="score-label">Capacità Vitale</div>
                    <div class="track">
                        <div class="bar" id="stress"></div>
                    </div>
                    <div class="indicators">
                        <span>1</span><span>2</span><span>3</span>
                    </div>
                </div>                
            </div>
        </div>

        
        <!-- SISTEMA IMMUNITARIO -->
        <div class="container-box-score">
            <h3>Sistema Immunitario</h3>
            <div class="container-score">
                <div class="score-box">
                    <div class="score-label">Stress Ossidativo</div>
                    <div class="track">
                        <div class="bar" id="stress"></div>
                    </div>
                    <div class="indicators">
                        <span>1</span><span>2</span><span>3</span>
                    </div>
                </div>
    
                <div class="score-box">
                    <div class="score-label">Disbiosi Intestinale</div>
                    <div class="track">
                        <div class="bar" id="disbiosi"></div>
                    </div>
                    <div class="indicators">
                        <span>1</span><span>2</span><span>3</span>
                    </div>
                </div>
    
                <div class="score-box">
                    <div class="score-label">Sistema immunitario</div>
                    <div class="track">
                        <div class="bar" id="immunitary_sistem"></div>
                    </div>
                    <div class="indicators">
                        <span>1</span><span>2</span><span>3</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ENERGIA E METABOLISMO -->
        <div class="container-box-score">
            <h3>Energia e metabolismo</h3>

            <div class="container-score">
                <div class="secondType-scoreBox">
                    <p>Punteggio Totalizzato dal questionario sulla stanchezza percepita (Fatigue Severity Scale)</p>
                    <p class="value">{{ datiEstesi.Fss }}</p>
                </div>

                <div class="score-box">
                    <div class="score-label">Weist height ratio</div>
                    <div class="track">
                        <div class="bar" id="stress"></div>
                    </div>
                    <div class="indicators">
                        <span>1</span><span>2</span><span>3</span>
                    </div>
                </div>


                <div class="score-box">
                    <div class="score-label">Weist hip ratio</div>
                    <div class="track">
                        <div class="bar" id="stress"></div>
                    </div>
                    <div class="indicators">
                        <span>1</span><span>2</span><span>3</span>
                    </div>
                </div>
            </div>

        </div>

        <!-- FUNZIONE MUSCOLARE -->
        <div class="container-box-score">
            <h3>Funzione Muscolare</h3>

            <div class="container-score">
                <div class="secondType-scoreBox">
                    <p>Punteggio Totalizzato dal questionario della Sarcopenia</p>
                    <p class="value">{{ datiEstesi.sarc_f }}</p>
                </div>

                <div class="score-box">
                    <div class="score-label">Hand Grip Strenght Test</div>
                    <div class="track">
                        <div class="bar" id="stress"></div>
                    </div>
                    <div class="indicators">
                        <span>1</span><span>2</span><span>3</span>
                    </div>
                </div>

                <div class="score-box">
                    <div class="score-label">Circonferenza del Polpaccio</div>
                    <div class="track">
                        <div class="bar" id="stress"></div>
                    </div>
                    <div class="indicators">
                        <span>1</span><span>2</span><span>3</span>
                    </div>
                </div>
            </div>

        </div>

        <!-- PERFORMANCE FISICA -->
        <div class="container-box-score">
            <h3>Performance Fisica</h3>

            <div class="container-score">
                <div class="score-box" style="width: 33%;">
                    <div class="score-label">Hand Grip Strenght Test</div>
                    <div class="track">
                        <div class="bar" id="stress"></div>
                    </div>
                    <div class="indicators">
                        <span>1</span><span>2</span><span>3</span>
                    </div>
                </div>
            </div>

        </div>

        
        <!-- BIOMARCATORI CIRCOLANTI DELL'INFIAMMAZIONE-->
        <div class="container-box-score">
            <h3>Biomarcatori Circolanti dell'Infiammazione</h3>

            <div class="container-score" style="margin-top: 1rem;">
                <div class="secondType-scoreBox">
                    <p>Lymph %</p>
                    <p class="value">{{ datiEstesi.Lymph }}</p>
                </div>

                <div class="secondType-scoreBox">
                    <p>Lymph</p>
                    <p class="value">{{ datiEstesi.Lymph_el }}</p>
                </div>

                <div class="secondType-scoreBox">
                    <p>Wbc</p>
                    <p class="value">{{ datiEstesi.wbc }}</p>
                </div>

                <div class="secondType-scoreBox">
                    <p>Proteina C reattiva</p>
                    <p class="value">{{ datiEstesi.Proteins_c }}</p>
                </div>
            </div>

            <div class="container-score" style="margin-top: 1rem;">

                <div class="secondType-scoreBox">
                    <p>Interleuchina 6</p>
                    <p class="value">{{ datiEstesi.Inter_6 }}</p>
                </div>

                <div class="secondType-scoreBox">
                    <p>TNF (Tumor Necrosis 
                        Factor) alfa </p>
                    <p class="value">{{ datiEstesi.Tnf }}</p>
                </div>

                <div class="secondType-scoreBox">
                    <p>Mono %</p>
                    <p class="value">{{ datiEstesi.Mono }}</p>
                </div>

                <div class="secondType-scoreBox">
                    <p>Mono </p>
                    <p class="value">{{ datiEstesi.Mono_el }}</p>
                </div>
               
            </div>
        </div>

        <!-- BIOMARCATORI CIRCOLANTI DEL METABOLISMO -->
        <div class="container-box-score">
            <h3>Biomarcatori Circolanti del Metabolismo</h3>

            <div class="container-score" style="margin-top: 1rem;">
                <div class="secondType-scoreBox">
                    <p>Glicemia a digiuno</p>
                    <p class="value">{{ datiEstesi.Glic }}</p>
                </div>

                <div class="secondType-scoreBox">
                    <p>Emoglobina glicata (HbA1c)</p>
                    <p class="value">{{ datiEstesi.Emog }}</p>
                </div>

                <div class="secondType-scoreBox">
                    <p>Insulina a digiuno </p>
                    <p class="value">{{ datiEstesi.Insu }}</p>
                </div>
                <div class="secondType-scoreBox">
                    <p>Peptide C </p>
                    <p class="value">{{ datiEstesi.Pept_c }}</p>
                </div>

                
            </div>

            <div class="container-score" style="margin-top: 1rem;">

                <div class="secondType-scoreBox">
                    <p>Colesterolo totale </p>
                    <p class="value">{{ datiEstesi.Col_tot }}</p>
                </div>

                <div class="secondType-scoreBox">
                    <p>Colesterolo LDL </p>
                    <p class="value">{{ datiEstesi.Col_ldl }}</p>
                </div>

                <div class="secondType-scoreBox">
                    <p>Colesterolo HDL  </p>
                    <p class="value">{{ datiEstesi.Col_hdl }}</p>
                </div>

                <div class="secondType-scoreBox">
                    <p>Trigliceridi </p>
                    <p class="value">{{ datiEstesi.Trigl }}</p>
                </div>
               
            </div>

            <div class="container-score" style="margin-top: 1rem;">

                <div class="secondType-scoreBox">
                    <p>Albumina </p>
                    <p class="value">{{ datiEstesi.albumina }}</p>
                </div>

                <div class="secondType-scoreBox">
                    <p>Clearance urea </p>
                    <p class="value">{{ datiEstesi.clearance_urea }}</p>
                </div>

                <div class="secondType-scoreBox">
                    <p>IGF-1 </p>
                    <p class="value">{{ datiEstesi.igf_1 }}</p>
                </div>

                <div class="secondType-scoreBox" style="background-color: var(--card-color);">
                    <p style="color: var(--card-color);">Trigliceridi </p>
                    <p style="color: var(--card-color); background-color: var(--card-color);" class="value">1</p>
                </div>
               
            </div>

            
        </div>







        <!-- GENERA PDF COMPLETO -->
        <button class="generatePDFButton button" id="screenshotBtn">
            <span class="button__icon-wrapper">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" width="18" class="button__icon-svg">
                    <path d="M6 2H14L18 6V20C18 21.1 17.1 22 16 22H6C4.9 22 4 21.1 4 20V4C4 2.9 4.9 2 6 2Z"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                    <path d="M14 2V6H18" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round"></path>
                </svg>
    
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" width="18"
                    class="button__icon-svg button__icon-svg--copy">
                    <path d="M6 2H14L18 6V20C18 21.1 17.1 22 16 22H6C4.9 22 4 21.1 4 20V4C4 2.9 4.9 2 6 2Z"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                    <path d="M14 2V6H18" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round"></path>
                </svg>
            </span>
            Genera PDF Completo
        </button>
    
        <!-- SPINNER -->
        <div id="spinnerBackdrop">
            <!-- From Uiverse.io by milley69 -->
            <!-- From Uiverse.io by Nawsome -->
            <div id="snipperStampa">
                <div class="slide"><i></i></div>
                <div class="paper"></div>
                <div class="keyboard"></div>
            </div>
            <!-- <div id="snipperStampa">
                        <svg width="128px" height="96px" viewBox="0 0 64 48" style="width: 128px; height: 96px;">
                            <polyline points="0.157 23.954, 14 23.954, 21.843 48, 43 0, 50 24, 64 24" id="back"></polyline>
                            <polyline points="0.157 23.954, 14 23.954, 21.843 48, 43 0, 50 24, 64 24" id="front"></polyline>
                        </svg>
                    </div> -->
        </div>
    
        <!-- SCRIPT -->
        <script>
            /*  -----------------------------------------------------------------------------------------------
            Set Score with gsap
            --------------------------------------------------------------------------------------------------- */
            function setScore(id, score, maxScore = 3) {
                const percentage = (score / maxScore) * 100;
                gsap.to(`#${id}`, {
                    width: `${percentage}%`,
                    duration: 1.5,
                    ease: "power2.out",
                });
            }

            setScore("stress", 2.5);
            setScore("disbiosi", 1.8);
            setScore("immunitary_sistem", 2.9);
            /*  -----------------------------------------------------------------------------------------------
              GENERA PDF COMPLETO
            --------------------------------------------------------------------------------------------------- */
            window.onload = function () {
                document.getElementById('screenshotBtn').addEventListener('click', function () {
                    const cards = document.querySelectorAll('.stampa');
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();


                    document.getElementById('snipperStampa').style.display = 'block';
                    document.getElementById('spinnerBackdrop').style.display = 'block';
                    document.body.style.overflow = 'hidden';

                    let yOffset = 10;

                    function captureCard(index) {
                        if (index >= cards.length) {

                            document.getElementById('snipperStampa').style.display = 'none';
                            document.getElementById('spinnerBackdrop').style.display = 'none';
                            document.body.style.overflow = 'auto';
                            doc.save('FULL-REPORT.pdf');
                            return;
                        }


                        html2canvas(cards[index]).then(function (canvas) {
                            var img = canvas.toDataURL('image/png');
                            var pageWidth = doc.internal.pageSize.width;
                            var pageHeight = doc.internal.pageSize.height;


                            var imgWidth = pageWidth - 20;
                            var imgHeight = canvas.height * imgWidth / canvas.width;


                            if (yOffset + imgHeight > pageHeight) {
                                doc.addPage();
                                yOffset = 10;
                            }


                            doc.addImage(img, 'PNG', 10, yOffset, imgWidth, imgHeight);

                            yOffset += imgHeight + 10;

                            captureCard(index + 1);
                        }).catch(function (error) {
                            console.error('Errore nella creazione dello screenshot:', error);
                        });
                    }

                    captureCard(0);
                });
            };
        </script>
        </div>
    </main>


   
   
</body>
</html>

